# Tox configuration for VideoLingo
# Multi-environment testing and development automation

[tox]
minversion = 4.0
envlist = py{39,310,311,312}, coverage, lint, security, docs, performance
isolated_build = true
skip_missing_interpreters = true

[testenv]
# Base test environment configuration
deps = 
    pytest>=7.4.0
    pytest-cov>=4.1.0
    pytest-xdist[psutil]>=3.3.1
    pytest-mock>=3.11.1
    pytest-asyncio>=0.21.0
    pytest-timeout>=2.1.0
    pytest-benchmark>=4.0.0
    pytest-html>=3.2.0
    pytest-json-report>=1.5.0
    # Core dependencies for testing
    numpy>=1.26.4
    pandas>=2.2.3
    librosa>=0.10.2
    PyYAML>=6.0.2
    requests>=2.32.3
    
extras = 
    dev
    audio

allowlist_externals = 
    make
    rm
    echo
    find

setenv =
    PYTHONPATH = {toxinidir}
    COVERAGE_FILE = {envtmpdir}/.coverage
    # Disable GPU for testing environments
    CUDA_VISIBLE_DEVICES = ""
    # Disable model downloads for testing
    HF_DATASETS_OFFLINE = 1
    TRANSFORMERS_OFFLINE = 1

commands = 
    # Clean previous test artifacts
    rm -rf {toxinidir}/tests/reports/*
    # Run tests with coverage
    pytest {posargs:tests/} \
        -v \
        --tb=short \
        --strict-markers \
        --cov=core \
        --cov-branch \
        --cov-report=term-missing:skip-covered \
        --cov-report=html:{toxinidir}/tests/reports/coverage_html_{envname} \
        --cov-report=xml:{toxinidir}/tests/reports/coverage_{envname}.xml \
        --cov-report=json:{toxinidir}/tests/reports/coverage_{envname}.json \
        --cov-fail-under=70 \
        --durations=10 \
        --html={toxinidir}/tests/reports/pytest_report_{envname}.html \
        --json-report --json-report-file={toxinidir}/tests/reports/pytest_{envname}.json \
        -n auto \
        --dist worksteal \
        -m "not slow and not network and not gpu and not external"

[testenv:py39]
basepython = python3.9
deps = {[testenv]deps}

[testenv:py310] 
basepython = python3.10
deps = {[testenv]deps}

[testenv:py311]
basepython = python3.11
deps = {[testenv]deps}

[testenv:py312]
basepython = python3.12
deps = {[testenv]deps}

[testenv:coverage]
# Comprehensive coverage testing across all Python versions
basepython = python3.11
deps = 
    {[testenv]deps}
    coverage[toml]>=7.2.0
    coverage-badge>=1.1.0
    
commands =
    # Remove previous coverage data
    coverage erase
    # Run tests with coverage collection
    pytest tests/ \
        -v \
        --cov=core \
        --cov-branch \
        --cov-report=term-missing:skip-covered \
        --cov-report=html:{toxinidir}/tests/reports/coverage_html_combined \
        --cov-report=xml:{toxinidir}/tests/reports/coverage_combined.xml \
        --cov-report=json:{toxinidir}/tests/reports/coverage_combined.json \
        --cov-fail-under=75 \
        -n auto \
        -m "not slow and not network and not gpu and not external"
    # Generate coverage badge
    coverage-badge -f -o {toxinidir}/tests/reports/coverage_badge.svg
    # Report final coverage
    coverage report --show-missing --precision=2

[testenv:lint]
# Code quality and static analysis
basepython = python3.11
deps =
    black>=23.7.0
    isort>=5.12.0
    flake8>=6.0.0
    mypy>=1.5.0
    pylint>=2.17.0
    bandit>=1.7.5
    
commands =
    # Code formatting check
    black --check --diff core/ tests/
    # Import sorting check  
    isort --check-only --diff core/ tests/
    # Linting
    flake8 core/ tests/ --max-line-length=100 --extend-ignore=E203,W503
    # Type checking (non-blocking for now)
    - mypy core/ --ignore-missing-imports --no-strict-optional
    # Security scanning
    bandit -r core/ -f json -o {toxinidir}/tests/reports/bandit_report.json
    # Pylint analysis
    pylint core/ --output-format=json:{toxinidir}/tests/reports/pylint_report.json,colorized

[testenv:security]
# Security testing and vulnerability scanning
basepython = python3.11
deps =
    bandit>=1.7.5
    safety>=2.3.5
    pip-audit>=2.6.1
    
commands =
    # Security linting
    bandit -r core/ -f json -o {toxinidir}/tests/reports/bandit_security.json
    # Dependency vulnerability scanning
    safety check --json --output {toxinidir}/tests/reports/safety_report.json
    # PyPI package auditing
    pip-audit --format=json --output={toxinidir}/tests/reports/pip_audit.json

[testenv:docs]
# Documentation building and testing
basepython = python3.11
deps =
    sphinx>=7.1.0
    sphinx-rtd-theme>=1.3.0
    recommonmark>=0.7.1
    
commands =
    # Build documentation
    sphinx-build -W -b html docs/ {toxinidir}/tests/reports/docs_html/
    # Check for broken links
    sphinx-build -W -b linkcheck docs/ {toxinidir}/tests/reports/docs_linkcheck/

[testenv:performance]
# Performance testing and benchmarking
basepython = python3.11
deps =
    {[testenv]deps}
    pytest-benchmark>=4.0.0
    memory-profiler>=0.61.0
    py-spy>=0.3.14
    
commands =
    # Run performance tests
    pytest tests/ \
        -v \
        --benchmark-only \
        --benchmark-json={toxinidir}/tests/reports/benchmark_results.json \
        --benchmark-histogram={toxinidir}/tests/reports/benchmark_histogram \
        --benchmark-compare-fail=mean:10% \
        -m "performance" \
        --tb=short

[testenv:integration]
# Integration testing with external dependencies
basepython = python3.11
deps = 
    {[testenv]deps}
    # Additional integration test dependencies
    docker>=6.1.3
    
setenv =
    {[testenv]setenv}
    # Allow network access for integration tests
    PYTEST_NETWORK_TESTS = 1
    
commands =
    pytest tests/integration/ tests/e2e/ \
        -v \
        --tb=short \
        --durations=20 \
        --html={toxinidir}/tests/reports/integration_report.html \
        -m "integration or e2e" \
        --maxfail=3 \
        --timeout=1800  # 30 minutes timeout for integration tests

[testenv:gpu]
# GPU-specific testing (requires CUDA environment)
basepython = python3.11
deps = 
    {[testenv]deps}
    torch>=2.0.0
    torchaudio>=2.0.0
    
setenv =
    {[testenv]setenv}
    # Enable GPU for testing
    CUDA_VISIBLE_DEVICES = 0
    
commands =
    pytest tests/ \
        -v \
        --tb=short \
        -m "gpu or ai" \
        --html={toxinidir}/tests/reports/gpu_test_report.html \
        --timeout=3600  # 1 hour timeout for GPU tests

[testenv:fast]
# Fast test suite for development
basepython = python3.11
deps = {[testenv]deps}
commands =
    pytest tests/ \
        -x \
        --tb=line \
        --durations=5 \
        -m "fast or smoke" \
        --maxfail=3 \
        -q

[testenv:dev]
# Development environment setup
basepython = python3.11
deps = 
    {[testenv]deps}
    ipython>=8.14.0
    jupyter>=1.0.0
    pre-commit>=3.3.3
    
commands =
    # Install pre-commit hooks
    pre-commit install
    # Run a quick development test
    pytest tests/unit/ -x --tb=short -m "smoke" -q

[testenv:clean]
# Clean up test artifacts and temporary files
basepython = python3.11
deps =
allowlist_externals = 
    rm
    find
    
commands =
    rm -rf {toxinidir}/tests/reports/*
    rm -rf {toxinidir}/htmlcov*/
    rm -rf {toxinidir}/.coverage*
    rm -rf {toxinidir}/.pytest_cache/
    rm -rf {toxinidir}/.tox/
    find {toxinidir} -type d -name "__pycache__" -exec rm -rf {{}} +
    find {toxinidir} -type f -name "*.pyc" -delete
    find {toxinidir} -type f -name "*.pyo" -delete

# Global tox configuration
[gh-actions]
# GitHub Actions Python version mapping
python = 
    3.9: py39
    3.10: py310
    3.11: py311
    3.12: py312

[coverage:run]
# Coverage configuration (referenced from .coveragerc)
source = core
parallel = true
branch = true

[coverage:report]
# Coverage reporting configuration
show_missing = true
precision = 2
fail_under = 75

[pytest]
# Pytest configuration (mirrors pytest.ini)
testpaths = tests
python_files = test_*.py
python_functions = test_*
addopts = 
    --strict-markers
    --tb=short
    -ra
markers =
    fast: Fast tests (< 1 second)
    slow: Slow tests (> 5 seconds)
    smoke: Essential smoke tests
    unit: Unit tests
    integration: Integration tests
    e2e: End-to-end tests
    network: Tests requiring network
    gpu: Tests requiring GPU
    external: Tests requiring external services
    ai: AI/ML tests
    audio: Audio processing tests
    video: Video processing tests
    ui: UI tests
    performance: Performance/benchmark tests