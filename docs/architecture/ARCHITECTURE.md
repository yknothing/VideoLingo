# VideoLingo æ–°æ¶æ„è®¾è®¡æ–‡æ¡£

## ğŸ—ï¸ æ¶æ„æ¦‚è¿°

VideoLingo å·²å‡çº§ä¸ºåŸºäºè§†é¢‘IDçš„æ–‡ä»¶ç®¡ç†æ¶æ„ï¼Œå®ç°äº†å®‰å…¨ã€å¯è¿½æº¯çš„æ–‡ä»¶ç»„ç»‡ç³»ç»Ÿã€‚

### æ ¸å¿ƒåŸåˆ™
1. **åŸºäºIDçš„æ–‡ä»¶æ˜ å°„** - æ¯ä¸ªè§†é¢‘æœ‰å”¯ä¸€IDï¼Œæ‰€æœ‰ç›¸å…³æ–‡ä»¶éƒ½é€šè¿‡IDå…³è”
2. **1:1:n æ˜ å°„å…³ç³»** - ä¸€ä¸ªåŸå§‹è§†é¢‘ â†’ ä¸€ä¸ªtempæ–‡ä»¶å¤¹ â†’ å¤šä¸ªè¾“å‡ºæ–‡ä»¶
3. **ç¦æ­¢åˆ é™¤ï¼Œå…è®¸è¦†ç›–** - ä¸åˆ é™¤ç”¨æˆ·æ•°æ®ï¼Œåªå…è®¸åŒè§†é¢‘IDè¦†ç›–
4. **å®Œå…¨éš”ç¦»** - ä¸åŒè§†é¢‘çš„å¤„ç†è¿‡ç¨‹äº’ä¸å¹²æ‰°

## ğŸ“ æ–‡ä»¶ç»„ç»‡ç»“æ„

### æ–°æ¶æ„æ–‡ä»¶å¸ƒå±€
```
video_storage/
â”œâ”€â”€ input/                          # åŸå§‹è§†é¢‘æ–‡ä»¶
â”‚   â”œâ”€â”€ abc12345_def6_789012.mp4   # æ ¼å¼: {video_id}.{ext}
â”‚   â””â”€â”€ xyz98765_abc1_234567.mp4
â”œâ”€â”€ temp/                           # æŒ‰è§†é¢‘IDç»„ç»‡çš„ä¸´æ—¶æ–‡ä»¶
â”‚   â”œâ”€â”€ abc12345_def6_789012/       # è§†é¢‘IDç›®å½•
â”‚   â”‚   â”œâ”€â”€ .metadata.json         # è§†é¢‘å…ƒæ•°æ®
â”‚   â”‚   â”œâ”€â”€ log/                    # å¤„ç†æ—¥å¿—
â”‚   â”‚   â”œâ”€â”€ gpt_log/               # GPTäº¤äº’æ—¥å¿—
â”‚   â”‚   â”œâ”€â”€ audio/                 # éŸ³é¢‘å¤„ç†æ–‡ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ raw.mp3
â”‚   â”‚   â”‚   â”œâ”€â”€ vocal.mp3
â”‚   â”‚   â”‚   â”œâ”€â”€ segs/              # éŸ³é¢‘ç‰‡æ®µ
â”‚   â”‚   â”‚   â””â”€â”€ refers/            # å‚è€ƒéŸ³é¢‘
â”‚   â”‚   â”œâ”€â”€ subtitles.srt          # å­—å¹•æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ translation.json       # ç¿»è¯‘ç»“æœ
â”‚   â”‚   â””â”€â”€ logs/                  # æ“ä½œæ—¥å¿—
â”‚   â””â”€â”€ xyz98765_abc1_234567/
â”œâ”€â”€ output/                         # æœ€ç»ˆè¾“å‡ºæ–‡ä»¶
â”‚   â”œâ”€â”€ abc12345_def6_789012_sub.mp4      # å¸¦å­—å¹•ç‰ˆæœ¬
â”‚   â”œâ”€â”€ abc12345_def6_789012_dub.mp4      # é…éŸ³ç‰ˆæœ¬
â”‚   â”œâ”€â”€ abc12345_def6_789012_summary.txt  # æ€»ç»“æ–‡ä»¶
â”‚   â””â”€â”€ xyz98765_abc1_234567_sub.mp4
â””â”€â”€ history/                        # å†å²å­˜æ¡£ (å¯é€‰)
    â””â”€â”€ completed_videos/
```

### è§†é¢‘IDç”Ÿæˆè§„åˆ™
- **æ ¼å¼**: `{content_hash}_{name_hash}_{timestamp}`
- **ç¤ºä¾‹**: `a1b2c3d4_ef56_789012`
- **ç»„æˆ**:
  - `content_hash`: æ–‡ä»¶å†…å®¹å‰1MBçš„MD5å“ˆå¸Œ (8ä½)
  - `name_hash`: æ–‡ä»¶åçš„MD5å“ˆå¸Œ (4ä½)
  - `timestamp`: æ—¶é—´æˆ³å6ä½

## ğŸ”§ æ ¸å¿ƒç»„ä»¶

### 1. VideoFileManager (`core/utils/video_manager.py`)
```python
# ä¸»è¦åŠŸèƒ½
- generate_video_id()      # ç”Ÿæˆå”¯ä¸€è§†é¢‘ID
- register_video()         # æ³¨å†Œæ–°è§†é¢‘åˆ°ç³»ç»Ÿ
- get_video_paths()        # è·å–è§†é¢‘ç›¸å…³è·¯å¾„
- safe_overwrite_*()       # å®‰å…¨è¦†ç›–æ“ä½œ
```

### 2. PathAdapter (`core/utils/path_adapter.py`)
```python
# ä¸ºç°æœ‰ä»£ç æä¾›å…¼å®¹å±‚
- get_temp_file()          # è·å–ä¸´æ—¶æ–‡ä»¶è·¯å¾„
- get_output_file()        # è·å–è¾“å‡ºæ–‡ä»¶è·¯å¾„
- get_audio_dir()          # è·å–éŸ³é¢‘ç›®å½•
- reset_for_new_video()    # é‡ç½®è§†é¢‘ä¸Šä¸‹æ–‡
```

### 3. å®‰å…¨æ“ä½œåŸåˆ™
```python
# âœ… å…è®¸çš„æ“ä½œ
video_mgr.safe_overwrite_temp_files(video_id)    # è¦†ç›–ä¸´æ—¶æ–‡ä»¶
video_mgr.safe_overwrite_output_files(video_id)  # è¦†ç›–è¾“å‡ºæ–‡ä»¶

# âŒ ç¦æ­¢çš„æ“ä½œ  
shutil.rmtree(input_dir)                         # åˆ é™¤inputç›®å½•
os.remove(other_video_files)                     # åˆ é™¤å…¶ä»–è§†é¢‘æ–‡ä»¶
```

## ğŸ”„ å¤„ç†æµç¨‹

### 1. è§†é¢‘å¯¼å…¥æµç¨‹
```python
# 1. ç”¨æˆ·ä¸Šä¼ /ä¸‹è½½è§†é¢‘
video_path = "downloaded_video.mp4"

# 2. ç³»ç»Ÿç”ŸæˆIDå¹¶æ³¨å†Œ
video_id = video_mgr.register_video(video_path)
# ç»“æœ: abc12345_def6_789012

# 3. æ–‡ä»¶è‡ªåŠ¨ç»„ç»‡
# input/abc12345_def6_789012.mp4
# temp/abc12345_def6_789012/ (created)
```

### 2. å¤„ç†é˜¶æ®µè·¯å¾„è·å–
```python
# è·å–å½“å‰è§†é¢‘çš„è·¯å¾„
adapter = get_path_adapter()
temp_dir = adapter.get_temp_dir()          # temp/abc12345_def6_789012/
audio_dir = adapter.get_audio_dir()        # temp/abc12345_def6_789012/audio/
output_file = adapter.get_output_file("sub") # output/abc12345_def6_789012_sub.mp4
```

### 3. é‡æ–°å¤„ç†æµç¨‹
```python
# ç”¨æˆ·æƒ³é‡æ–°å¤„ç†åŒä¸€è§†é¢‘
current_id = adapter.get_current_video_id()

# å®‰å…¨é‡ç½®ï¼ˆä¸åˆ é™¤inputï¼‰
video_mgr.safe_overwrite_temp_files(current_id)
video_mgr.safe_overwrite_output_files(current_id)

# å¼€å§‹æ–°çš„å¤„ç†æµç¨‹...
```

## ğŸ›¡ï¸ å®‰å…¨ç‰¹æ€§

### 1. æ–‡ä»¶ä¿æŠ¤æœºåˆ¶
- **Inputä¿æŠ¤**: åŸå§‹è§†é¢‘æ–‡ä»¶æ°¸ä¸åˆ é™¤
- **éš”ç¦»å¤„ç†**: æ¯ä¸ªè§†é¢‘æœ‰ç‹¬ç«‹çš„å¤„ç†ç©ºé—´
- **è¦†ç›–æ—¥å¿—**: æ‰€æœ‰è¦†ç›–æ“ä½œéƒ½æœ‰æ—¥å¿—è®°å½•
- **å…ƒæ•°æ®è¿½è¸ª**: æ¯ä¸ªè§†é¢‘éƒ½æœ‰å®Œæ•´çš„å¤„ç†å†å²

### 2. é”™è¯¯æ¢å¤
- **ä¼˜é›…é™çº§**: æ–°æ¶æ„å¤±è´¥æ—¶è‡ªåŠ¨å›é€€åˆ°æ—§æ¨¡å¼
- **è·¯å¾„éªŒè¯**: æ‰€æœ‰æ“ä½œå‰éƒ½éªŒè¯è·¯å¾„åˆæ³•æ€§
- **å¼‚å¸¸å¤„ç†**: è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œæ¢å¤å»ºè®®

### 3. æ•°æ®å®Œæ•´æ€§
- **åŸå­æ“ä½œ**: æ–‡ä»¶æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸè¦ä¹ˆå…¨éƒ¨å›æ»š
- **ä¸€è‡´æ€§æ£€æŸ¥**: ç³»ç»Ÿå¯åŠ¨æ—¶éªŒè¯æ–‡ä»¶ç»“æ„å®Œæ•´æ€§
- **å¤‡ä»½æœºåˆ¶**: é‡è¦æ“ä½œå‰è‡ªåŠ¨åˆ›å»ºå¤‡ä»½ç‚¹

## ğŸ”„ è¿ç§»æŒ‡å—

### ç°æœ‰ä»£ç é€‚é…
```python
# æ—§ä»£ç 
output_path = "output/result.mp4"

# æ–°ä»£ç  (æ¨è)
adapter = get_path_adapter()
output_path = adapter.get_output_file("result")

# æˆ–è€…ç›´æ¥ä½¿ç”¨video manager
video_mgr = get_video_manager()
output_path = video_mgr.get_output_file(video_id, "result")
```

### å¸¸ç”¨æ¨¡å¼
```python
# 1. å¼€å§‹å¤„ç†æ–°è§†é¢‘
@with_video_context
def process_video():
    paths = get_current_video_paths()
    # ä½¿ç”¨pathsè¿›è¡Œå¤„ç†...

# 2. å®‰å…¨é‡ç½®
def reset_video_processing():
    adapter = get_path_adapter()
    video_id = adapter.get_current_video_id()
    if video_id:
        video_mgr.safe_overwrite_temp_files(video_id)

# 3. è·å–å†å²æ–‡ä»¶
def get_video_history(video_id):
    return video_mgr.list_temp_files(video_id)
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. ç¼“å­˜æœºåˆ¶
- è§†é¢‘IDç¼“å­˜é¿å…é‡å¤è®¡ç®—
- è·¯å¾„ç¼“å­˜å‡å°‘æ–‡ä»¶ç³»ç»Ÿè°ƒç”¨
- å…ƒæ•°æ®ç¼“å­˜æå‡æŸ¥è¯¢æ€§èƒ½

### 2. å¹¶è¡Œå¤„ç†
- ä¸åŒè§†é¢‘å¯ä»¥å®Œå…¨å¹¶è¡Œå¤„ç†
- åŒä¸€è§†é¢‘çš„ä¸åŒé˜¶æ®µå¯ä»¥æµæ°´çº¿å¤„ç†
- ä¸´æ—¶æ–‡ä»¶è¯»å†™ä½¿ç”¨ç¼“å†²åŒºä¼˜åŒ–

### 3. å­˜å‚¨ä¼˜åŒ–
- æŒ‰éœ€åˆ›å»ºç›®å½•ç»“æ„
- è‡ªåŠ¨æ¸…ç†è¿‡æœŸä¸´æ—¶æ–‡ä»¶
- å‹ç¼©å­˜å‚¨éæ´»è·ƒæ•°æ®

## ğŸ” ç›‘æ§å’Œè°ƒè¯•

### 1. æ—¥å¿—ç³»ç»Ÿ
```python
# æ“ä½œæ—¥å¿—
temp/video_id/logs/overwrite_operations.log

# å¤„ç†æ—¥å¿—  
temp/video_id/log/processing.log

# GPTäº¤äº’æ—¥å¿—
temp/video_id/gpt_log/interactions.log
```

### 2. è°ƒè¯•å·¥å…·
```python
# æŸ¥çœ‹å½“å‰çŠ¶æ€
video_mgr.get_current_video_id()
video_mgr.list_temp_files(video_id)
video_mgr.list_output_files(video_id)

# éªŒè¯æ–‡ä»¶ç»“æ„
adapter.get_current_video_paths()
```

## ğŸ“ˆ æœªæ¥æ‰©å±•

### 1. è®¡åˆ’åŠŸèƒ½
- å¤šç”¨æˆ·æ”¯æŒï¼ˆç”¨æˆ·ID + è§†é¢‘IDï¼‰
- åˆ†å¸ƒå¼å¤„ç†æ”¯æŒ
- äº‘å­˜å‚¨é›†æˆ
- è‡ªåŠ¨å­˜æ¡£ç®¡ç†

### 2. APIè®¾è®¡
- RESTful APIæ¥å£
- WebSocketå®æ—¶çŠ¶æ€æ›´æ–°
- æ‰¹é‡å¤„ç†API
- å†å²æŸ¥è¯¢API

---

**æ¶æ„ä¼˜åŠ¿æ€»ç»“**:
- âœ… å®Œå…¨çš„æ–‡ä»¶å®‰å…¨æ€§
- âœ… æ¸…æ™°çš„æ–‡ä»¶ç»„ç»‡ç»“æ„  
- âœ… å¯è¿½æº¯çš„å¤„ç†å†å²
- âœ… ä¼˜é›…çš„é”™è¯¯å¤„ç†
- âœ… å‘åå…¼å®¹æ€§
- âœ… é«˜æ€§èƒ½å’Œå¯æ‰©å±•æ€§