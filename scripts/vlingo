#!/usr/bin/env python3
"""
VideoLingo å…¨å±€å‘½ä»¤è¡Œç®¡ç†å·¥å…·
ç”¨äºç®¡ç†VideoLingoåº”ç”¨ç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸ
"""

import os
import sys
import subprocess
import signal
import time
import argparse
import json
import logging
from pathlib import Path
from datetime import datetime
import psutil

# é…ç½®æ—¥å¿—
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    datefmt='%Y-%m-%d %H:%M:%S'
)
logger = logging.getLogger(__name__)

class VideoLingoManager:
    """VideoLingo åº”ç”¨ç®¡ç†å™¨"""
    
    def __init__(self):
        self.app_name = "VideoLingo"
        self.script_dir = Path(__file__).parent
        self.config_file = self.script_dir / "config.yaml"
        self.pid_file = self.script_dir / ".vlingo.pid"
        self.log_file = self.script_dir / "vlingo.log"
        self.port = 8501
        
    def is_running(self):
        """æ£€æŸ¥åº”ç”¨æ˜¯å¦æ­£åœ¨è¿è¡Œ"""
        if not self.pid_file.exists():
            return False, None
            
        try:
            with open(self.pid_file, 'r') as f:
                pid = int(f.read().strip())
            
            if psutil.pid_exists(pid):
                proc = psutil.Process(pid)
                if 'streamlit' in ' '.join(proc.cmdline()).lower():
                    return True, pid
            
            # PIDæ–‡ä»¶å­˜åœ¨ä½†è¿›ç¨‹ä¸å­˜åœ¨ï¼Œæ¸…ç†æ–‡ä»¶
            self.pid_file.unlink()
            return False, None
            
        except (ValueError, psutil.NoSuchProcess, PermissionError):
            return False, None
    
    def start(self, background=True, dev_mode=False):
        """å¯åŠ¨VideoLingoåº”ç”¨"""
        running, pid = self.is_running()
        if running:
            logger.info(f"ğŸ“ {self.app_name} å·²åœ¨è¿è¡Œ (PID: {pid})")
            logger.info(f"ğŸŒ è®¿é—®åœ°å€: http://localhost:{self.port}")
            return True
        
        # æ£€æŸ¥é…ç½®æ–‡ä»¶
        if not self.config_file.exists():
            logger.error(f"âŒ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: {self.config_file}")
            logger.info("ğŸ’¡ è¯·å…ˆè¿è¡Œ: vlingo setup")
            return False
        
        # æ£€æŸ¥ä¾èµ–
        if not self._check_dependencies():
            logger.error("âŒ ä¾èµ–æ£€æŸ¥å¤±è´¥")
            return False
        
        logger.info(f"ğŸš€ å¯åŠ¨ {self.app_name}...")
        
        try:
            # æ„å»ºå¯åŠ¨å‘½ä»¤
            cmd = [
                sys.executable, "-m", "streamlit", "run", "st.py",
                "--server.port", str(self.port),
                "--server.address", "localhost",
                "--browser.gatherUsageStats", "false"
            ]
            
            if dev_mode:
                cmd.extend(["--server.runOnSave", "true"])
            
            # å¯åŠ¨è¿›ç¨‹
            if background:
                with open(self.log_file, 'w') as log_f:
                    process = subprocess.Popen(
                        cmd,
                        cwd=self.script_dir,
                        stdout=log_f,
                        stderr=subprocess.STDOUT,
                        preexec_fn=os.setsid if os.name != 'nt' else None
                    )
                
                # ä¿å­˜PID
                with open(self.pid_file, 'w') as f:
                    f.write(str(process.pid))
                
                # ç­‰å¾…å¯åŠ¨
                time.sleep(3)
                
                # éªŒè¯å¯åŠ¨æˆåŠŸ
                if self._check_port():
                    logger.info(f"âœ… {self.app_name} å¯åŠ¨æˆåŠŸ!")
                    logger.info(f"ğŸ“Š è¿›ç¨‹ID: {process.pid}")
                    logger.info(f"ğŸŒ è®¿é—®åœ°å€: http://localhost:{self.port}")
                    logger.info(f"ğŸ“ æ—¥å¿—æ–‡ä»¶: {self.log_file}")
                    return True
                else:
                    logger.error("âŒ å¯åŠ¨å¤±è´¥ï¼Œç«¯å£æ£€æŸ¥ä¸é€šè¿‡")
                    return False
            else:
                # å‰å°è¿è¡Œ
                logger.info(f"ğŸŒ è®¿é—®åœ°å€: http://localhost:{self.port}")
                logger.info("âŒ¨ï¸  æŒ‰ Ctrl+C åœæ­¢æœåŠ¡")
                subprocess.run(cmd, cwd=self.script_dir)
                return True
                
        except Exception as e:
            logger.error(f"âŒ å¯åŠ¨å¤±è´¥: {e}")
            return False
    
    def stop(self):
        """åœæ­¢VideoLingoåº”ç”¨"""
        running, pid = self.is_running()
        if not running:
            logger.info(f"â„¹ï¸  {self.app_name} æœªåœ¨è¿è¡Œ")
            return True
        
        logger.info(f"ğŸ›‘ åœæ­¢ {self.app_name} (PID: {pid})...")
        
        try:
            # å‘é€ç»ˆæ­¢ä¿¡å·
            if os.name == 'nt':  # Windows
                subprocess.run(['taskkill', '/F', '/T', '/PID', str(pid)], 
                             capture_output=True)
            else:  # Unix/Linux/macOS
                os.killpg(os.getpgid(pid), signal.SIGTERM)
            
            # ç­‰å¾…è¿›ç¨‹ç»“æŸ
            for _ in range(10):
                if not psutil.pid_exists(pid):
                    break
                time.sleep(0.5)
            
            # å¼ºåˆ¶ç»ˆæ­¢
            if psutil.pid_exists(pid):
                if os.name == 'nt':
                    subprocess.run(['taskkill', '/F', '/T', '/PID', str(pid)])
                else:
                    os.killpg(os.getpgid(pid), signal.SIGKILL)
            
            # æ¸…ç†PIDæ–‡ä»¶
            if self.pid_file.exists():
                self.pid_file.unlink()
            
            logger.info(f"âœ… {self.app_name} å·²åœæ­¢")
            return True
            
        except Exception as e:
            logger.error(f"âŒ åœæ­¢å¤±è´¥: {e}")
            return False
    
    def restart(self, background=True, dev_mode=False):
        """é‡å¯VideoLingoåº”ç”¨"""
        logger.info(f"ğŸ”„ é‡å¯ {self.app_name}...")
        self.stop()
        time.sleep(2)
        return self.start(background, dev_mode)
    
    def status(self):
        """æ˜¾ç¤ºåº”ç”¨çŠ¶æ€"""
        running, pid = self.is_running()
        
        print(f"\n{'='*50}")
        print(f"ğŸ“Š {self.app_name} çŠ¶æ€æŠ¥å‘Š")
        print(f"{'='*50}")
        
        if running:
            proc = psutil.Process(pid)
            print(f"ğŸŸ¢ çŠ¶æ€: è¿è¡Œä¸­")
            print(f"ğŸ“Š è¿›ç¨‹ID: {pid}")
            print(f"ğŸŒ ç«¯å£: {self.port}")
            print(f"ğŸ’¾ å†…å­˜ä½¿ç”¨: {proc.memory_info().rss / 1024 / 1024:.1f} MB")
            print(f"â° è¿è¡Œæ—¶é—´: {datetime.now() - datetime.fromtimestamp(proc.create_time())}")
            print(f"ğŸŒ è®¿é—®åœ°å€: http://localhost:{self.port}")
        else:
            print(f"ğŸ”´ çŠ¶æ€: æœªè¿è¡Œ")
        
        print(f"ğŸ“ å·¥ä½œç›®å½•: {self.script_dir}")
        print(f"âš™ï¸  é…ç½®æ–‡ä»¶: {self.config_file}")
        print(f"ğŸ“ æ—¥å¿—æ–‡ä»¶: {self.log_file}")
        print(f"{'='*50}\n")
    
    def logs(self, lines=50, follow=False):
        """æ˜¾ç¤ºåº”ç”¨æ—¥å¿—"""
        if not self.log_file.exists():
            logger.info("ğŸ“ æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨")
            return
        
        try:
            if follow:
                logger.info("ğŸ“ å®æ—¶æ—¥å¿— (æŒ‰ Ctrl+C é€€å‡º):")
                subprocess.run(['tail', '-f', str(self.log_file)])
            else:
                logger.info(f"ğŸ“ æœ€è¿‘ {lines} è¡Œæ—¥å¿—:")
                with open(self.log_file, 'r', encoding='utf-8') as f:
                    log_lines = f.readlines()
                    for line in log_lines[-lines:]:
                        print(line.rstrip())
        except Exception as e:
            logger.error(f"âŒ è¯»å–æ—¥å¿—å¤±è´¥: {e}")
    
    def setup(self):
        """è®¾ç½®å‘å¯¼"""
        print(f"\nğŸ› ï¸  {self.app_name} è®¾ç½®å‘å¯¼")
        print("="*50)
        
        # æ£€æŸ¥é…ç½®æ–‡ä»¶
        if self.config_file.exists():
            print(f"âœ… é…ç½®æ–‡ä»¶å·²å­˜åœ¨: {self.config_file}")
            response = input("æ˜¯å¦é‡æ–°é…ç½®? (y/N): ").lower()
            if response != 'y':
                return
        
        # APIé…ç½®
        print("\nğŸ“‹ API é…ç½®")
        print("æ¨èä½¿ç”¨ OpenRouter (æ”¯æŒå¤šç§æ¨¡å‹)")
        
        api_key = input("è¯·è¾“å…¥ API Key (OpenRouter: sk-or-v1-xxx): ").strip()
        if not api_key:
            logger.error("âŒ API Key ä¸èƒ½ä¸ºç©º")
            return False
        
        api_base = input("API Base URL [https://openrouter.ai/api/v1]: ").strip()
        if not api_base:
            api_base = "https://openrouter.ai/api/v1"
        
        model = input("æ¨¡å‹åç§° [anthropic/claude-3.5-sonnet]: ").strip()
        if not model:
            model = "anthropic/claude-3.5-sonnet"
        
        # åˆ›å»ºé…ç½®
        config_content = f"""# VideoLingo é…ç½®æ–‡ä»¶
# è‡ªåŠ¨ç”Ÿæˆæ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}

# APIé…ç½®
api:
  key: '{api_key}'
  base_url: '{api_base}'
  model: '{model}'
  llm_support_json: true

# åŸºç¡€è®¾ç½®
target_language: 'zh-CN'
resolution: '1080p'
max_workers: 2

# è§†é¢‘å­˜å‚¨é…ç½®
video_storage:
  base_path: './output'
  
# TTSé…ç½®
tts:
  method: 'edge'
  voice: 'zh-CN-XiaoxiaoNeural'
  
# ASRé…ç½®  
asr:
  method: 'openai_api'
  
# ç¿»è¯‘é…ç½®
translation:
  target_language: 'zh-CN'
  chunk_size: 800
  
# è¾“å‡ºé…ç½®
output:
  subtitle_enabled: true
  audio_enabled: true
"""
        
        with open(self.config_file, 'w', encoding='utf-8') as f:
            f.write(config_content)
        
        logger.info(f"âœ… é…ç½®æ–‡ä»¶å·²åˆ›å»º: {self.config_file}")
        logger.info("ğŸš€ ç°åœ¨å¯ä»¥è¿è¡Œ: vlingo start")
        return True
    
    def install(self):
        """å®‰è£…ä¾èµ–"""
        logger.info("ğŸ“¦ å®‰è£… VideoLingo ä¾èµ–...")
        
        install_script = self.script_dir / "install_minimal.py"
        if install_script.exists():
            subprocess.run([sys.executable, str(install_script)])
        else:
            logger.error(f"âŒ å®‰è£…è„šæœ¬ä¸å­˜åœ¨: {install_script}")
            return False
        
        return True
    
    def _check_dependencies(self):
        """æ£€æŸ¥ä¾èµ–"""
        required_modules = ['streamlit', 'openai', 'requests', 'yaml']
        missing = []
        
        for module in required_modules:
            try:
                __import__(module)
            except ImportError:
                missing.append(module)
        
        if missing:
            logger.error(f"âŒ ç¼ºå°‘ä¾èµ–: {', '.join(missing)}")
            logger.info("ğŸ’¡ è¯·è¿è¡Œ: vlingo install")
            return False
        
        return True
    
    def _check_port(self):
        """æ£€æŸ¥ç«¯å£æ˜¯å¦å¯ç”¨"""
        import socket
        try:
            with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
                result = s.connect_ex(('localhost', self.port))
                return result == 0
        except:
            return False

def main():
    """ä¸»å‡½æ•°"""
    parser = argparse.ArgumentParser(
        description="VideoLingo å…¨å±€å‘½ä»¤è¡Œç®¡ç†å·¥å…·",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
ä½¿ç”¨ç¤ºä¾‹:
  vlingo start          # åå°å¯åŠ¨åº”ç”¨
  vlingo start -f       # å‰å°å¯åŠ¨åº”ç”¨  
  vlingo start -d       # å¼€å‘æ¨¡å¼å¯åŠ¨
  vlingo stop           # åœæ­¢åº”ç”¨
  vlingo restart        # é‡å¯åº”ç”¨
  vlingo status         # æŸ¥çœ‹çŠ¶æ€
  vlingo logs           # æŸ¥çœ‹æ—¥å¿—
  vlingo logs -f        # å®æ—¶æ—¥å¿—
  vlingo setup          # é…ç½®å‘å¯¼
  vlingo install        # å®‰è£…ä¾èµ–
        """
    )
    
    parser.add_argument('command', 
                       choices=['start', 'stop', 'restart', 'status', 'logs', 'setup', 'install'],
                       help='è¦æ‰§è¡Œçš„å‘½ä»¤')
    
    parser.add_argument('-f', '--foreground', action='store_true',
                       help='å‰å°è¿è¡Œ (ä»…ç”¨äºstartå‘½ä»¤)')
    
    parser.add_argument('-d', '--dev', action='store_true',
                       help='å¼€å‘æ¨¡å¼ (ä»…ç”¨äºstartå‘½ä»¤)')
    
    parser.add_argument('--follow', action='store_true',
                       help='å®æ—¶è·Ÿè¸ªæ—¥å¿— (ä»…ç”¨äºlogså‘½ä»¤)')
    
    parser.add_argument('-n', '--lines', type=int, default=50,
                       help='æ˜¾ç¤ºæ—¥å¿—è¡Œæ•° (é»˜è®¤: 50)')
    
    args = parser.parse_args()
    
    # åˆ›å»ºç®¡ç†å™¨å®ä¾‹
    manager = VideoLingoManager()
    
    # æ‰§è¡Œå‘½ä»¤
    try:
        if args.command == 'start':
            success = manager.start(
                background=not args.foreground, 
                dev_mode=args.dev
            )
        elif args.command == 'stop':
            success = manager.stop()
        elif args.command == 'restart':
            success = manager.restart(
                background=not args.foreground,
                dev_mode=args.dev
            )
        elif args.command == 'status':
            manager.status()
            success = True
        elif args.command == 'logs':
            manager.logs(lines=args.lines, follow=args.follow)
            success = True
        elif args.command == 'setup':
            success = manager.setup()
        elif args.command == 'install':
            success = manager.install()
        
        sys.exit(0 if success else 1)
        
    except KeyboardInterrupt:
        logger.info("\nğŸ‘‹ ç”¨æˆ·ä¸­æ–­")
        sys.exit(0)
    except Exception as e:
        logger.error(f"âŒ æ‰§è¡Œå¤±è´¥: {e}")
        sys.exit(1)

if __name__ == "__main__":
    main()